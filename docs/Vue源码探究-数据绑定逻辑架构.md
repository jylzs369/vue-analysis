# Vue源码探究-数据绑定逻辑架构

*本篇源代码所在路径[vue/src/core/observer/](https://github.com/vuejs/vue/tree/v2.5.17-beta.0/src/core/observer)*

观察者系统是Vue实现数据绑定、异步更新的核心模块，观察者系统的实现也是Vue源码里最为复杂的部分，在仔细研究具体实现之前，先对整个数据绑定的逻辑架构进行一个充分的认识，会更有助于解读源码。

## 数据绑定逻辑架构
数据更新触发刷新页面的过程主要依赖观察者系统里三角关系。在这个系统中，主要角色分别是 `Observer`、`Dep`、`Watcher` 这三个对象，对于每一个角色在监听数据更新的流程中各自承担的职责需要深入进行理解。下面请出三个主角登场，来介绍一下它们：

### Observer
`Observer` 在数据绑定逻辑架构中的职责是收集需要观察的数据对象，并递归地对每一个需要观察的对象添加依赖的监听器。这里非常巧妙的是触发通知监听器数据更新的事件的注册，一般的发布订阅模式需要建立一个事件管理器来统一管理各种事件的注册，然而Vue的数据绑定不需要这样的机制，它借用 `Object.defineProperty` 方法来为每一个被监听的数据设置了存取器，依靠数据的存取行为自然地实现了事件的触发。在初始化Vue实例中设置的 `data` 属性时，对这些输入的数据对象对行了依赖追踪，这个过程中监听器的依赖添加是不可见的；而通过配置 `watch` 属性显式设置的监听器，就可以在实例的 `_watchers` 私有属性中查看到。每个组件初始化后有一个唯一的 `_watcher` 对象，它是一个用来监听在 `data` 中注册的数据变动从而更新视图的监听器，它也默认被添加到了各属性的依赖监听数组中。在每个修改为可观察状态的属性中，都含有一个 `Dep` 实例，这个对象的 `subs` 属性就是用来存放依赖的所有监听器 `Watcher` 实例对象，`subs` 可以理解为订阅者，即所有订阅了该数据对象变动的监听器的数组集合。之所以需要在一开始为数据收集依赖，参考另一些开发者的总结是由于并非所有的数据都值得监听，要知道监听没有用到的数据就是对性能的浪费，在实例观察中也确实发现，页面中没有用到的属性，没有被初始化为依赖项，这样即便改变了它的数值，页面也不会触发多余的刷新。

### Dep
Dep是用来存放每一个可监听对象所依赖的监听器，


### Watcher
Watcher是这个架构中的监听器

---

从Vue对象实例化着手到开始分析数据绑定的核心实现，这一路过来还没有真正遇到值得困扰的问题。但未曾想到的是，数据绑定这个Vue的核心特色功能竟然让我苦苦研读了好几天，似乎以前对于发布订阅设计模式的了解显得那样无力。期间去搜索了一些前人做的分析说明文章以求从各个角度深入理解，但大多数解读读完后依然觉得没能很透彻地理解这个模块，后来读到了一个[简易实现Vue观察者系统的文章](https://www.jb51.net/article/107927.htm)，让我一下明白了核心逻辑是如何实现的，也许第一次读源码的时候太多非核心的技术实现干扰了对于核心部分的理解，所以也从这一次学习中得到了一个很好的经验，要更加关注本质。